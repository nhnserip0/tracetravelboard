<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Trace Travel - Qu·∫£n l√Ω Xe</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f0f0f0; }
    .controls { margin-bottom: 20px; }
    .locations { display: flex; flex-wrap: wrap; gap: 20px; }
    .location { background: #fff; border: 1px solid #ccc; border-radius: 6px; width: 250px; padding: 10px; }
    .zone { background: #eee; padding: 5px; border-radius: 4px; min-height: 50px; margin-top: 10px; }
    .zone-title { font-weight: bold; margin-bottom: 5px; cursor: pointer; }
    .bike { padding: 6px; margin: 5px 0; border-radius: 4px; color: white; text-align: center; cursor: move; }
    .bike-buttons { margin-top: 4px; font-size: 12px; }
    .bike-buttons button { margin: 0 2px; }
    #bikeDetail {
      display: none; position: fixed; top: 10%; left: 50%;
      transform: translateX(-50%); background: #fff;
      padding: 20px; border: 1px solid #ccc; z-index: 1000;
    }
    #summary { margin-top: 20px; font-weight: bold; }
@media (max-width: 700px) {
  body {
    padding: 6px;
    font-size: 16px;
  }
  .controls {
    flex-direction: column;
    gap: 8px;
    margin-bottom: 10px;
  }
  .locations {
    flex-direction: column;
    gap: 12px;
  }
  .location {
    width: 98vw;
    min-width: 0;
    padding: 8px;
    font-size: 15px;
  }
  .zone-title {
    font-size: 18px;
    padding: 5px 0;
  }
  .bike {
    font-size: 15px;
    padding: 8px 2px;
  }
  .bike-buttons button {
    font-size: 15px;
    padding: 4px 7px;
  }
  #bikeDetail, #searchMoveBox {
    width: 97vw !important;
    max-width: 370px;
    left: 50% !important;
    transform: translateX(-50%);
    font-size: 16px;
    padding: 12px 4px;
  }
}

.controls input, .controls button {
  font-size: 16px;
  padding: 8px 10px;
  margin-bottom: 4px;
}

  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<div class="controls">
  <input id="bikeIdInput" placeholder="Bi·ªÉn s·ªë xe" />
  <button id="addBikeBtn">‚ûï Th√™m xe</button>
  <input id="newLocInput" placeholder="T√™n kho m·ªõi" />
  <button id="addLocBtn">‚ûï Th√™m kho</button>
  <button onclick="exportToExcel()">üì§ Xu·∫•t Excel</button>
</div>

<div class="locations" id="locationBoard"></div>

<div id="bikeDetail">
  <h3>Th√¥ng tin xe: <span id="detailId"></span></h3>
  <label>Ng√†y giao: <input type="date" id="detailStart"></label><br>
  <label>Ng√†y tr·∫£: <input type="date" id="detailEnd"></label><br>
  <label>Ng∆∞·ªùi giao: <input type="text" id="detailPerson"></label><br><br>
  <button onclick="saveBikeDetail()">L∆∞u</button>
  <button onclick="closeBikeDetail()">ƒê√≥ng</button>
</div>

<div id="summary"></div>

<div id="searchMoveBox" style="display:none; padding: 20px; background:#fff; border:1px solid #ccc; position:fixed; top:20%; left:50%; transform:translateX(-50%); z-index:1000;">
  <h3>Chuy·ªÉn xe v√†o khu v·ª±c: <span id="searchMoveTarget"></span></h3>
  <input id="bikeSearchInput" placeholder="Nh·∫≠p bi·ªÉn s·ªë xe..." style="width: 100%; padding: 8px; margin-top:10px;" />
  <div id="bikeSearchResults" style="max-height:200px; overflow-y:auto; margin-top:10px;"></div>
  <button onclick="document.getElementById('searchMoveBox').style.display='none'">Hu·ª∑</button>
</div>

<script>
let state = JSON.parse(localStorage.getItem("traceBoardState")) || {
  locations: ["Trace Travel"],
  bikes: []
};
let selectedBike = null;

// H√†m v·∫Ω l·∫°i to√†n b·ªô board, g·∫Øn event k√©o th·∫£, click, c·∫≠p nh·∫≠t th·ªëng k√™
function renderBoard() {
  const board = document.getElementById("locationBoard");
  board.innerHTML = "";
  let countIn = 0, countOut = 0, countFix = 0;

  state.locations.forEach(loc => {
    const container = document.createElement("div");
    container.className = "location";

    const title = document.createElement("div");
    const titleText = document.createElement("h3");
    titleText.textContent = loc;
    titleText.onclick = () => renameLocation(loc);
    title.appendChild(titleText);
    if (loc !== "Trace Travel") {
      const del = document.createElement("button");
      del.textContent = "üóë";
      del.onclick = () => deleteLocation(loc);
      title.appendChild(del);
    }
    container.appendChild(title);

    ["IN", "OUT", "NOT_READY"].forEach(type => {
      const zone = document.createElement("div");
      zone.className = "zone";
      zone.dataset.loc = loc;
      zone.dataset.type = type;
      const zt = document.createElement("div");
      zt.className = "zone-title";
      zt.textContent = type;
      zone.appendChild(zt);
      container.appendChild(zone);
    });

    board.appendChild(container);
  });

  state.bikes.forEach(b => {
  const now = new Date();
  const endDate = b.end ? new Date(b.end) : null;
  let bg;
  if (endDate) {
    const todayStr = now.toISOString().slice(0,10);
    const endStr = endDate.toISOString().slice(0,10);
    if (todayStr < endStr) {
      bg = b.color === "yellow" ? "orange" : b.color === "red" ? "red" : "#4caf50";
    } else if (todayStr === endStr) {
      bg = "purple";
    } else {
      bg = "black";
    }
  } else {
    bg = b.color === "yellow" ? "orange" : b.color === "red" ? "red" : "#4caf50";
  }
  const type = b.color === "yellow" ? "OUT" : b.color === "red" ? "NOT_READY" : "IN";
  const zone = document.querySelector(`.zone[data-loc="${b.loc}"][data-type="${type}"]`);
  if (!zone) return;

  const el = document.createElement("div");
  el.className = "bike";
  el.style.background = bg;
  el.innerHTML = `
  <div><b>${b.id}</b></div>
  <div style="font-size:12px;white-space:pre-line;line-height:1.3;">
    <div>üöö ${b.start ? b.start : '--'}</div>
    <div>‚è∞ ${b.end ? b.end : '--'}</div>
    <div>üë§ ${b.person ? b.person : '--'}</div>
  </div>
  <div class="bike-buttons">
    <button onclick="setColor('${b.id}', 'green'); event.stopPropagation()">‚úÖ</button>
    <button onclick="setColor('${b.id}', 'yellow'); event.stopPropagation()">üü°</button>
    <button onclick="setColor('${b.id}', 'red'); event.stopPropagation()">üîß</button>
    <button onclick="deleteBike('${b.id}'); event.stopPropagation()">‚ùå</button>
  </div>
`;
  el.onclick = () => showBikeDetail(b.id);
  el.draggable = true;
  el.addEventListener("dragstart", () => {
    el.classList.add("dragging");
    el.dataset.dragId = b.id;
  });
  el.addEventListener("dragend", () => el.classList.remove("dragging"));
  zone.appendChild(el);

  if (type === "IN") countIn++;
  if (type === "OUT") countOut++;
  if (type === "NOT_READY") countFix++;
});

  document.getElementById("summary").textContent = `ƒêang thu√™: ${countOut} | Kh√¥ng thu√™: ${countIn} | C·∫ßn s·ª≠a: ${countFix}`;
  enableDragDrop();
  addZoneClickSearch();
}

function addBike() {
  const input = document.getElementById("bikeIdInput");
  const id = input.value.trim();
  if (id && !state.bikes.find(b => b.id === id)) {
    state.bikes.push({ id, loc: "Trace Travel", color: "green" });
    saveState(); renderBoard(); input.value = "";
  }
}

function addLocation() {
  const input = document.getElementById("newLocInput");
  const name = input.value.trim();
  if (name && !state.locations.includes(name)) {
    state.locations.push(name);
    saveState(); renderBoard(); input.value = "";
  }
}

function deleteBike(id) {
  if (confirm("Xo√° xe " + id + "?")) {
    state.bikes = state.bikes.filter(b => b.id !== id);
    saveState(); renderBoard();
  }
}

function setColor(id, color) {
  const b = state.bikes.find(b => b.id === id);
  if (b) {
    b.color = color;
    saveState(); renderBoard();
  }
}

function renameLocation(oldName) {
  const newName = prompt("ƒê·ªïi t√™n kho:", oldName);
  if (newName && newName !== oldName) {
    state.locations = state.locations.map(l => l === oldName ? newName : l);
    state.bikes.forEach(b => { if (b.loc === oldName) b.loc = newName });
    saveState(); renderBoard();
  }
}

function deleteLocation(loc) {
  if (!confirm("Xo√° kho '" + loc + "' v√† to√†n b·ªô xe trong ƒë√≥?")) return;
  state.bikes = state.bikes.filter(b => b.loc !== loc);
  state.locations = state.locations.filter(l => l !== loc);
  saveState(); renderBoard();
}

// Popup chi ti·∫øt xe
function showBikeDetail(id) {
  const b = state.bikes.find(x => x.id === id);
  if (!b) return;
  selectedBike = b;
  document.getElementById("bikeDetail").style.display = "block";
  document.getElementById("detailId").textContent = b.id;
  document.getElementById("detailStart").value = b.start || "";
  document.getElementById("detailEnd").value = b.end || "";
  document.getElementById("detailPerson").value = b.person || "";
}
function closeBikeDetail() {
  document.getElementById("bikeDetail").style.display = "none";
}
function saveBikeDetail() {
  if (!selectedBike) return;
  selectedBike.start = document.getElementById("detailStart").value;
  selectedBike.end = document.getElementById("detailEnd").value;
  selectedBike.person = document.getElementById("detailPerson").value;
  saveState(); renderBoard(); closeBikeDetail();
}

// Modal t√¨m ki·∫øm & chuy·ªÉn xe qua v√πng
function filterBikeResults(targetLoc, targetType) {
  const input = document.getElementById("bikeSearchInput").value.toLowerCase();
  const resultBox = document.getElementById("bikeSearchResults");
  resultBox.innerHTML = "";
  state.bikes.filter(b => b.id.toLowerCase().includes(input)).forEach(b => {
    const btn = document.createElement("div");
    btn.textContent = b.id + " (" + b.loc + ")";
    btn.style.cursor = "pointer";
    btn.style.padding = "5px";
    btn.style.borderBottom = "1px solid #ccc";
    btn.onclick = () => {
      b.loc = targetLoc;
      b.color = targetType === "IN" ? "green" : targetType === "OUT" ? "yellow" : "red";
      saveState(); renderBoard();
      document.getElementById("searchMoveBox").style.display = "none";
    };
    resultBox.appendChild(btn);
  });
}

// Xu·∫•t Excel
function exportToExcel() {
  const ws_data = [["Bi·ªÉn s·ªë", "Kho", "Tr·∫°ng th√°i", "Ng√†y giao", "Ng√†y tr·∫£", "Ng∆∞·ªùi giao"]];
  state.bikes.forEach(b => {
    ws_data.push([b.id, b.loc, b.color, b.start || "", b.end || "", b.person || ""]);
  });
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Danh_sach_xe");
  XLSX.writeFile(wb, "Danh_sach_xe.xlsx");
}

// K√©o th·∫£
function enableDragDrop() {
  document.querySelectorAll(".zone").forEach(zone => {
    zone.addEventListener("dragover", e => e.preventDefault());
    zone.addEventListener("drop", e => {
      const dragging = document.querySelector(".bike.dragging");
      const id = dragging?.dataset?.dragId;
      const b = state.bikes.find(x => x.id === id);
      if (b) {
        b.loc = zone.dataset.loc;
        b.color = zone.dataset.type === "IN" ? "green" : zone.dataset.type === "OUT" ? "yellow" : "red";
        saveState(); renderBoard();
      }
    });
  });
}

// Click ti√™u ƒë·ªÅ v√πng ƒë·ªÉ m·ªü popup chuy·ªÉn xe
function addZoneClickSearch() {
  document.querySelectorAll(".zone-title").forEach(title => {
    title.onclick = () => {
      const zone = title.parentElement;
      const loc = zone.dataset.loc;
      const type = zone.dataset.type;
      document.getElementById("searchMoveBox").style.display = "block";
      document.getElementById("searchMoveTarget").textContent = `${loc} / ${type}`;
      document.getElementById("bikeSearchInput").value = "";
      document.getElementById("bikeSearchResults").innerHTML = "";
      document.getElementById("bikeSearchInput").oninput = () => filterBikeResults(loc, type);
    };
  });
}

// L∆∞u tr·∫°ng th√°i
function saveState() {
  localStorage.setItem("traceBoardState", JSON.stringify(state));
}

// Kh·ªüi t·∫°o
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("addBikeBtn").onclick = addBike;
  document.getElementById("addLocBtn").onclick = addLocation;
  renderBoard();
});
</script>

</body>
</html>
